{% extends "layout.html" %}

{% block content %}
<section class="panel form-panel">
  <div class="panel-header">
    <div>
      <h2>{{ 'Edit' if usage else 'Tambah' }} Penggunaan</h2>
      <p class="muted">Lengkapi data penggunaan listrik pelanggan.</p>
    </div>
    <a class="btn ghost" href="{{ url_for('admin_usages') }}">Kembali</a>
  </div>
  <form method="post" class="form-grid">
    <label class="field">
      <span>Pelanggan</span>
      <select name="id_pelanggan" id="customerSelect" required>
        {% for customer in customers %}
          <option value="{{ customer.id_pelanggan }}" {% if usage and customer.id_pelanggan == usage.id_pelanggan %}selected{% endif %}>
            {{ customer.nama_pelanggan }} ({{ customer.username }})
          </option>
        {% endfor %}
      </select>
    </label>
    <label class="field">
      <span>Bulan</span>
      <input type="number" name="bulan" id="bulanInput" min="1" max="12" value="{{ usage.bulan if usage else '' }}" required>
    </label>
    <label class="field">
      <span>Tahun</span>
      <input type="number" name="tahun" id="tahunInput" min="2000" value="{{ usage.tahun if usage else '' }}" required>
    </label>
    <label class="field">
      <span>Meter Awal</span>
      <input type="number" name="meter_awal" id="meterAwalInput" min="0" value="{{ usage.meter_awal if usage else '' }}" required>
    </label>
    <label class="field">
      <span>Meter Akhir</span>
      <input type="number" name="meter_akhir" min="0" value="{{ usage.meter_akhir if usage else '' }}" required>
    </label>
    <div class="form-actions">
      <button class="btn primary" type="submit">Simpan</button>
    </div>
  </form>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const customerSelect = document.getElementById('customerSelect');
    const bulanInput = document.getElementById('bulanInput');
    const tahunInput = document.getElementById('tahunInput');
    const meterAwalInput = document.getElementById('meterAwalInput');
    const isNewUsageForm = !({{ 'true' if usage else 'false' }}); // Check if it's a new form

    async function fetchLastUsage(customerId) {
      try {
        const response = await fetch(`/admin/api/get_last_usage/${customerId}`);
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error fetching last usage:', error);
        return { bulan: null, tahun: null, meter_awal: null };
      }
    }

    // Function to update form fields
    function updateFormFields(data) {
      bulanInput.value = data.bulan !== null ? data.bulan : '';
      tahunInput.value = data.tahun !== null ? data.tahun : '';
      meterAwalInput.value = data.meter_awal !== null ? data.meter_awal : '';
    }

    // Only pre-fill if it's a new usage form
    if (isNewUsageForm) {
      customerSelect.addEventListener('change', async function() {
        const selectedCustomerId = this.value;
        if (selectedCustomerId) {
          const data = await fetchLastUsage(selectedCustomerId);
          updateFormFields(data);
        } else {
          // Clear fields if no customer selected
          bulanInput.value = '';
          tahunInput.value = '';
          meterAwalInput.value = '';
        }
      });

      // Initial load: if a customer is already selected (e.g., from a previous POST request or initial rendering)
      // and it's a new form, try to pre-fill.
      if (customerSelect.value) {
        fetchLastUsage(customerSelect.value).then(data => {
            updateFormFields(data);
        });
      }
    }
  });
</script>
{% endblock %}
